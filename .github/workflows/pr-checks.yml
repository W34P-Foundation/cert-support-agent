name: Pull Request Checks

on:
  pull_request:
    branches:
      - '**'

jobs:
  sql-validation:
    name: SQL Syntax Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SQLite
        run: sudo apt-get update && sudo apt-get install -y sqlite3

      - name: Validate schema.sql syntax
        run: |
          echo "Validating schema.sql..."
          sqlite3 :memory: < src/schema.sql
          echo "✅ schema.sql is valid SQLite syntax"

      - name: Find and validate all SQL files
        run: |
          echo "Searching for all SQL files..."
          SQL_FILES=$(find . -name "*.sql" -not -path "./node_modules/*" -not -path "./.git/*")
          
          if [ -z "$SQL_FILES" ]; then
            echo "No SQL files found"
            exit 0
          fi
          
          echo "Found SQL files:"
          echo "$SQL_FILES"
          echo ""
          
          EXIT_CODE=0
          for file in $SQL_FILES; do
            echo "Validating $file..."
            if sqlite3 :memory: < "$file" 2>&1; then
              echo "✅ $file is valid"
            else
              echo "❌ $file has syntax errors"
              EXIT_CODE=1
            fi
            echo ""
          done
          
          exit $EXIT_CODE

  sensitive-data-check:
    name: Sensitive Data Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for sensitive data patterns
        run: |
          echo "Checking for sensitive data patterns..."
          EXIT_CODE=0
          
          # Check for real email addresses (excluding example domains)
          echo "Checking for real email addresses..."
          REAL_EMAILS=$(git diff origin/${{ github.base_ref }}...HEAD | grep -E "^\+" | grep -iE "[a-z0-9._%+-]+@(?!example\.com|example\.org|test\.com|localhost|domain\.com)[a-z0-9.-]+\.[a-z]{2,}" || true)
          if [ -n "$REAL_EMAILS" ]; then
            echo "⚠️  Warning: Potential real email addresses detected:"
            echo "$REAL_EMAILS"
            echo ""
            echo "Please ensure these are not real user emails. Use example.com or similar domains for test data."
            EXIT_CODE=1
          fi
          
          # Check for phone numbers in various formats
          echo "Checking for phone numbers..."
          PHONE_NUMBERS=$(git diff origin/${{ github.base_ref }}...HEAD | grep -E "^\+" | grep -E "(\+?1[-.\s]?)?\(?[0-9]{3}\)?[-.\s]?[0-9]{3}[-.\s]?[0-9]{4}|[0-9]{3}-[0-9]{3}-[0-9]{4}|[0-9]{10}" | grep -vE "(000-000-0000|111-111-1111|123-456-7890|555-[0-9]{3}-[0-9]{4}|tracking|1Z[A-Z0-9]+|9[0-9]{21}|7[0-9]{14})" || true)
          if [ -n "$PHONE_NUMBERS" ]; then
            echo "⚠️  Warning: Potential phone numbers detected:"
            echo "$PHONE_NUMBERS"
            echo ""
            echo "Please ensure these are not real phone numbers."
            EXIT_CODE=1
          fi
          
          # Check for Social Security Numbers
          echo "Checking for SSNs..."
          SSN_PATTERNS=$(git diff origin/${{ github.base_ref }}...HEAD | grep -E "^\+" | grep -E "[0-9]{3}-[0-9]{2}-[0-9]{4}" | grep -vE "(000-00-0000|123-45-6789)" || true)
          if [ -n "$SSN_PATTERNS" ]; then
            echo "⚠️  Warning: Potential SSN patterns detected:"
            echo "$SSN_PATTERNS"
            echo ""
            echo "Please ensure these are not real SSNs."
            EXIT_CODE=1
          fi
          
          # Check for credit card numbers (basic pattern)
          echo "Checking for credit card patterns..."
          CC_PATTERNS=$(git diff origin/${{ github.base_ref }}...HEAD | grep -E "^\+" | grep -E "[0-9]{4}[- ]?[0-9]{4}[- ]?[0-9]{4}[- ]?[0-9]{4}" | grep -vE "(0000-0000-0000-0000|1111-1111-1111-1111|1234-5678-9012-3456)" || true)
          if [ -n "$CC_PATTERNS" ]; then
            echo "⚠️  Warning: Potential credit card patterns detected:"
            echo "$CC_PATTERNS"
            echo ""
            echo "Please ensure these are not real credit card numbers."
            EXIT_CODE=1
          fi
          
          # Check for AWS keys
          echo "Checking for AWS keys..."
          AWS_KEYS=$(git diff origin/${{ github.base_ref }}...HEAD | grep -E "^\+" | grep -iE "(AKIA[0-9A-Z]{16}|aws_access_key_id|aws_secret_access_key)" || true)
          if [ -n "$AWS_KEYS" ]; then
            echo "❌ ERROR: Potential AWS keys detected:"
            echo "$AWS_KEYS"
            echo ""
            EXIT_CODE=1
          fi
          
          # Check for private keys
          echo "Checking for private keys..."
          PRIVATE_KEYS=$(git diff origin/${{ github.base_ref }}...HEAD | grep -E "^\+" | grep -iE "(BEGIN.*PRIVATE KEY|BEGIN RSA PRIVATE KEY)" || true)
          if [ -n "$PRIVATE_KEYS" ]; then
            echo "❌ ERROR: Potential private keys detected:"
            echo "$PRIVATE_KEYS"
            echo ""
            EXIT_CODE=1
          fi
          
          # Check for API tokens and secrets
          echo "Checking for API tokens..."
          API_TOKENS=$(git diff origin/${{ github.base_ref }}...HEAD | grep -E "^\+" | grep -iE "(api[_-]?key|api[_-]?token|api[_-]?secret|access[_-]?token|auth[_-]?token)['\"]?\s*[:=]\s*['\"]?[a-z0-9]{20,}" | grep -viE "(example|test|demo|placeholder|YOUR_API_KEY|<|>)" || true)
          if [ -n "$API_TOKENS" ]; then
            echo "⚠️  Warning: Potential API keys or tokens detected:"
            echo "$API_TOKENS"
            echo ""
            echo "Please ensure these are not real API keys. Use environment variables or placeholder values."
            EXIT_CODE=1
          fi
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "✅ No sensitive data patterns detected"
          else
            echo ""
            echo "❌ Sensitive data check failed. Please review the warnings above."
          fi
          
          exit $EXIT_CODE

  file-integrity-check:
    name: File Structure Integrity
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify required files exist
        run: |
          echo "Verifying required files..."
          EXIT_CODE=0
          
          REQUIRED_FILES=(
            "src/schema.sql"
            "package.json"
            "README.md"
            ".gitignore"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "✅ $file exists"
            else
              echo "❌ $file is missing"
              EXIT_CODE=1
            fi
          done
          
          exit $EXIT_CODE

      - name: Check for suspicious file patterns
        run: |
          echo "Checking for suspicious files..."
          EXIT_CODE=0
          
          # Check for backup files
          BACKUP_FILES=$(find . -type f \( -name "*.bak" -o -name "*.backup" -o -name "*~" \) -not -path "./node_modules/*" -not -path "./.git/*" || true)
          if [ -n "$BACKUP_FILES" ]; then
            echo "⚠️  Warning: Backup files detected:"
            echo "$BACKUP_FILES"
            echo ""
            EXIT_CODE=1
          fi
          
          # Check for .env files (except .env.example)
          ENV_FILES=$(find . -type f -name ".env" -not -name ".env.example" -not -path "./node_modules/*" -not -path "./.git/*" || true)
          if [ -n "$ENV_FILES" ]; then
            echo "❌ ERROR: .env files detected (should be in .gitignore):"
            echo "$ENV_FILES"
            echo ""
            EXIT_CODE=1
          fi
          
          # Check for database files
          DB_FILES=$(find . -type f \( -name "*.db" -o -name "*.sqlite" -o -name "*.sqlite3" \) -not -path "./node_modules/*" -not -path "./.git/*" || true)
          if [ -n "$DB_FILES" ]; then
            echo "⚠️  Warning: Database files detected:"
            echo "$DB_FILES"
            echo ""
            echo "Please ensure these are test databases and not production data."
            EXIT_CODE=1
          fi
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "✅ No suspicious files detected"
          else
            echo ""
            echo "Please review the warnings above and ensure no sensitive files are committed."
          fi
          
          exit $EXIT_CODE

      - name: Validate file permissions
        run: |
          echo "Checking for executable files..."
          
          # Find files with execute permissions (excluding .git directory)
          EXECUTABLE_FILES=$(find . -type f -executable -not -path "./.git/*" -not -path "./node_modules/*" || true)
          
          if [ -n "$EXECUTABLE_FILES" ]; then
            echo "⚠️  Warning: Executable files detected:"
            echo "$EXECUTABLE_FILES"
            echo ""
            echo "Please review if these files should have execute permissions."
          else
            echo "✅ No unexpected executable files found"
          fi

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: Check for hardcoded secrets with Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
